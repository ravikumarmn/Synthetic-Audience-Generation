#!/usr/bin/env python3
"""
Test RAG Integration in Main Synthetic Audience MVP

This script tests the RAG functionality integrated into the main application.
"""

import os
import sys
import json
import tempfile
import logging

# Add src directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "src"))

from synthetic_audience_mvp import SyntheticAudienceGenerator, RAG_AVAILABLE

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def create_test_input(num_profiles: int = 5) -> str:
    """Create a test input file."""
    test_data = {
        "request": [
            {
                "filter_details": {
                    "user_req_responses": num_profiles,
                    "age_filter": {"min": 25, "max": 45},
                    "age_proportions": {"25-34": 60, "35-44": 40},
                    "gender_filter": ["Male", "Female"],
                    "gender_proportions": {"Male": 50, "Female": 50},
                    "ethnicity_filter": ["White", "Hispanic"],
                    "ethnicity_proportions": {"White": 70, "Hispanic": 30},
                },
                "personas": [
                    {
                        "id": 1,
                        "generatedTitle": "Digital Marketing Professional",
                        "personaName": "Alex Marketing",
                        "age": 30,
                        "location": "San Francisco",
                        "ethnicity": "White",
                        "gender": "Male",
                        "personaType": "Professional",
                        "about": "Passionate about digital marketing and social media strategy",
                        "goalsAndMotivations": [
                            "Build a strong personal brand online",
                            "Learn advanced analytics tools",
                        ],
                        "frustrations": [
                            "Difficulty measuring ROI on campaigns",
                            "Keeping up with algorithm changes",
                        ],
                        "needState": "Seeking tools to optimize social media performance",
                        "occasions": "Most active during evening hours for content planning",
                    }
                ],
            }
        ]
    }

    # Create temporary file
    with tempfile.NamedTemporaryFile(mode="w", suffix=".json", delete=False) as f:
        json.dump(test_data, f, indent=2)
        return f.name


def test_standard_workflow():
    """Test standard workflow without RAG."""
    print("ğŸ§ª Testing Standard Workflow (No RAG)")
    print("=" * 50)

    input_file = create_test_input(3)
    output_file = tempfile.mktemp(suffix=".json")

    try:
        # Test standard parallel workflow
        generator = SyntheticAudienceGenerator(use_parallel=True, use_rag=False)
        stats = generator.process_request(input_file, output_file)

        print(f"âœ… Standard workflow completed")
        print(f"ğŸ“Š Generated {stats.get('total_profiles', 0)} profiles")

        # Check output file
        if os.path.exists(output_file):
            with open(output_file, "r") as f:
                result = json.load(f)
            print(
                f"ğŸ“ Output file contains {len(result.get('synthetic_profiles', []))} profiles"
            )

        return True

    except Exception as e:
        print(f"âŒ Standard workflow failed: {e}")
        return False
    finally:
        # Cleanup
        for file in [input_file, output_file]:
            if os.path.exists(file):
                os.unlink(file)


def test_rag_workflow():
    """Test RAG-enhanced workflow."""
    print("\nğŸ§ª Testing RAG-Enhanced Workflow")
    print("=" * 50)

    if not RAG_AVAILABLE:
        print("âš ï¸  RAG system not available - skipping RAG tests")
        return True

    input_file = create_test_input(3)
    output_file = tempfile.mktemp(suffix=".json")

    try:
        # Test RAG parallel workflow
        generator = SyntheticAudienceGenerator(use_parallel=True, use_rag=True)
        stats = generator.process_request(input_file, output_file)

        print(f"âœ… RAG workflow completed")
        print(f"ğŸ“Š Generated {stats.get('total_profiles', 0)} profiles")

        # Check output file
        if os.path.exists(output_file):
            with open(output_file, "r") as f:
                result = json.load(f)
            profiles = result.get("synthetic_profiles", [])
            print(f"ğŸ“ Output file contains {len(profiles)} profiles")

            # Check for RAG statistics
            if "rag_stats" in stats:
                rag_stats = stats["rag_stats"]
                print(f"ğŸ§  RAG Statistics:")
                print(f"   - Total generated: {rag_stats.get('total_generated', 0)}")
                print(
                    f"   - Total regenerated: {rag_stats.get('total_regenerated', 0)}"
                )
                print(f"   - Total duplicates: {rag_stats.get('total_duplicates', 0)}")

        return True

    except Exception as e:
        print(f"âŒ RAG workflow failed: {e}")
        import traceback

        traceback.print_exc()
        return False
    finally:
        # Cleanup
        for file in [input_file, output_file]:
            if os.path.exists(file):
                os.unlink(file)


def test_rag_sequential_workflow():
    """Test RAG-enhanced sequential workflow."""
    print("\nğŸ§ª Testing RAG-Enhanced Sequential Workflow")
    print("=" * 50)

    if not RAG_AVAILABLE:
        print("âš ï¸  RAG system not available - skipping RAG tests")
        return True

    input_file = create_test_input(2)  # Smaller for sequential
    output_file = tempfile.mktemp(suffix=".json")

    try:
        # Test RAG sequential workflow
        generator = SyntheticAudienceGenerator(use_parallel=False, use_rag=True)
        stats = generator.process_request(input_file, output_file)

        print(f"âœ… RAG sequential workflow completed")
        print(f"ğŸ“Š Generated {stats.get('total_profiles', 0)} profiles")

        return True

    except Exception as e:
        print(f"âŒ RAG sequential workflow failed: {e}")
        return False
    finally:
        # Cleanup
        for file in [input_file, output_file]:
            if os.path.exists(file):
                os.unlink(file)


def test_cli_integration():
    """Test CLI integration with RAG options."""
    print("\nğŸ§ª Testing CLI Integration")
    print("=" * 50)

    try:
        # Test help to see if RAG options are available
        import subprocess

        result = subprocess.run(
            [sys.executable, "synthetic_audience_mvp.py", "--help"],
            capture_output=True,
            text=True,
            cwd=os.path.join(os.path.dirname(__file__), "src"),
        )

        # Check for RAG options (be flexible with formatting)
        has_rag_flag = "--rag" in result.stdout and "--no-rag" in result.stdout
        has_rag_threshold = "--rag-threshold" in result.stdout
        has_rag_attempts = "--rag-max-attempts" in result.stdout

        if has_rag_flag and has_rag_threshold and has_rag_attempts:
            print("âœ… RAG CLI options available")
            return True
        else:
            print("âŒ RAG CLI options not found in help")
            print(f"Debug: --rag flag: {has_rag_flag}")
            print(f"Debug: --rag-threshold: {has_rag_threshold}")
            print(f"Debug: --rag-max-attempts: {has_rag_attempts}")
            return False

    except Exception as e:
        print(f"âŒ CLI test failed: {e}")
        return False


def main():
    """Run all integration tests."""
    print("ğŸ¯ RAG Integration Tests for Synthetic Audience MVP")
    print("=" * 60)

    print(f"ğŸ”§ Environment:")
    print(f"   - RAG Available: {RAG_AVAILABLE}")
    print(f"   - Python: {sys.version}")

    tests = [
        ("Standard Workflow", test_standard_workflow),
        ("RAG Workflow", test_rag_workflow),
        ("RAG Sequential", test_rag_sequential_workflow),
        ("CLI Integration", test_cli_integration),
    ]

    results = []
    for test_name, test_func in tests:
        try:
            success = test_func()
            results.append((test_name, success))
        except Exception as e:
            print(f"âŒ {test_name} crashed: {e}")
            results.append((test_name, False))

    # Summary
    print(f"\nğŸ“‹ Test Results Summary:")
    print("=" * 30)

    passed = 0
    for test_name, success in results:
        status = "âœ… PASS" if success else "âŒ FAIL"
        print(f"{status}: {test_name}")
        if success:
            passed += 1

    print(f"\nğŸ¯ Overall: {passed}/{len(results)} tests passed")

    if passed == len(results):
        print("ğŸ‰ All tests passed! RAG integration is working correctly.")
        return 0
    else:
        print("âš ï¸  Some tests failed. Check the output above for details.")
        return 1


if __name__ == "__main__":
    exit(main())
